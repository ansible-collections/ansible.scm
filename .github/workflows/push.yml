# push workflow is shared and expected to perform actions after a merge happens
# on a maintenance branch (default or release). For example updating the
# draft release-notes.
# based on great work from
# https://github.com/T-Systems-MMS/ansible-collection-icinga-director
name: push

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    # branches to consider in the event; optional, defaults to all
    branches:
      - main
      - 'releases/**'
      - 'stable/**'
    # Prevent a 2nd run after the changelog is updated
    paths-ignore:
      - CHANGELOG.rst
      - changelogs/changelog.yaml

env:
  NAMESPACE: ansible
  COLLECTION_NAME: scm
  ANSIBLE_COLLECTIONS_PATHS: ./

jobs:
  update_release_draft:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.5.0
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_DRAFTER_BOT }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install antsibull-changelog, antsichaut
        run: python -m pip install antsibull-changelog antsichaut pre-commit --disable-pip-version-check

      - name: Run release drafter
        id: release_drafter
        uses: release-drafter/release-drafter@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove the v prefix from the release drafter version
        run: |
          VERSION=${{ steps.release_drafter.outputs.tag_name }}
          echo "VERSION=${VERSION#v}" >> $GITHUB_ENV

      - name: Generate new version in changelog.yaml
        run: antsibull-changelog release -v --version "${{ env.VERSION }}"

      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@master"
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Generate changelog.yaml
        run: antsichaut
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SINCE_VERSION: "${{ steps.previoustag.outputs.tag }}"

      - name: Update Changelog.rst
        run: antsibull-changelog generate -v

      - name: Cleanup as needed using prettier
        run: pre-commit run prettier --all-files
        continue-on-error: true

      - name: Update the glaxay.yml version if needed
        run: pre-commit run autoversion --all-files
        continue-on-error: true

      - name: Commit changelog
        run: |
          git config user.name "Collection changelog updater"
          git config user.email noreply@ansible.com
          git add .
          git commit -m "Changelog updated"
          git push
