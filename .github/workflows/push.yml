# push workflow is shared and expected to perform actions after a merge happens
# on a maintenance branch (default or release). For example updating the
# draft release-notes.
# based on great work from
# https://github.com/T-Systems-MMS/ansible-collection-icinga-director
name: push

on:
  push:
    # branches to consider in the event; optional, defaults to all
    branches:
      - main
      - 'releases/**'
      - 'stable/**'
  workflow_call:  # allows reuse of this workflow from other devtools repos

env:
  NAMESPACE: ansible
  COLLECTION_NAME: scm
  ANSIBLE_COLLECTIONS_PATHS: ./

jobs:
  update_release_draft:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.5.0
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install antsibull-changelog, antsichaut
        run: python -m pip install antsibull-changelog antsichaut --disable-pip-version-check


      # Drafts your next Release notes as Pull Requests are merged into "main"
      - name: Run release drafter
        id: release_drafter
        uses: release-drafter/release-drafter@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate new version in changelog.yaml
        run: antsibull-changelog release -v --version "${{ steps.release_drafter.outputs.name }}"

      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@master"
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Generate changelog.yaml
        run: antsichaut
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SINCE_VERSION: "${{ steps.previoustag.outputs.tag }}"

      - name: Update Changelog.rst
        run: antsibull-changelog generate -v

      - name: push changelog
        uses: github-actions-x/commit@v2.9
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          push-branch: 'main'
          commit-message: 'update changelog'
          force-add: 'true'
          files: CHANGELOG.rst changelogs/
          name: 'Ansible devtools bot'
          email: 'devtools@ansible.com'
          rebase: true

      # do a second checkout to prevent race situation
      # changelog gets updated but action works on old commit id
      - uses: actions/checkout@v3.5.0
        with:
          ref: main
